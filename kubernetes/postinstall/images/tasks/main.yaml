---
- name: Update the etcd imagePullPolicy
  replace:
    dest: /etc/kubernetes/manifests/etcd.yaml
    regexp: '^    imagePullPolicy: IfNotPresent'
    replace: '    imagePullPolicy: Always'

- name: Update the kube-apiserver imagePullPolicy
  replace:
    dest: /etc/kubernetes/manifests/kube-apiserver.yaml
    regexp: '^    imagePullPolicy: IfNotPresent'
    replace: '    imagePullPolicy: Always'

- name: Update the kube-controller-manager imagePullPolicy
  replace:
    dest: /etc/kubernetes/manifests/kube-controller-manager.yaml
    regexp: '^    imagePullPolicy: IfNotPresent'
    replace: '    imagePullPolicy: Always'

- name: Update the kube-scheduler imagePullPolicy
  replace:
    dest: /etc/kubernetes/manifests/kube-scheduler.yaml
    regexp: '^    imagePullPolicy: IfNotPresent'
    replace: '    imagePullPolicy: Always'

- name: Update kube-apiserver admission controller to add AlwaysPullImages and ResourceQuota
  replace:
    dest: /etc/kubernetes/manifests/kube-apiserver.yaml
    regexp: '^    - --enable-admission-plugins=.*'
    replace: '    - --enable-admission-plugins=NodeRestriction,AlwaysPullImages,ResourceQuota'

- name: Update the etcd image to point to the Artifactory Instance
  replace:
    dest: /etc/kubernetes/manifests/etcd.yaml
    regexp: '^    image:.*'
    replace: '    image: systems-and-platforms-kubernetes.docker.west.com/etcd:3.3.15-0'

- name: Update the kube-apiserver image to point to the Artifactory Instance
  replace:
    dest: /etc/kubernetes/manifests/kube-apiserver.yaml
    regexp: '^    image:.*'
    replace: '    image: systems-and-platforms-kubernetes.docker.west.com/kube-apiserver:v1.16.8'

- name: Update the kube-controller-manager image to point to the Artifactory Instance
  replace:
    dest: /etc/kubernetes/manifests/kube-controller-manager.yaml
    regexp: '^    image:.*'
    replace: '    image: systems-and-platforms-kubernetes.docker.west.com/kube-controller-manager:v1.16.8'

- name: Update the kube-scheduler image to point to the Artifactory Instance
  replace:
    dest: /etc/kubernetes/manifests/kube-scheduler.yaml
    regexp: '^    image:.*'
    replace: '    image: systems-and-platforms-kubernetes.docker.west.com/kube-scheduler:v1.16.8'

