#!/usr/bin/ksh

# profile
# Carl Schelin
# usage: add to your .profile or .bash (/opt/intrado/bin/profile) so you see messages upon login
# check the system to make sure the intrado script has run
# check to see if the chkserver.output file exists
# then check for errors in the chkserver.output file
# then check for warnings in the chkserver.output file

ADMIN=/usr/local/admin
INTRADO=/opt/intrado
VAR=${INTRADO}/var
ETC=${INTRADO}/etc
LOGS=${VAR}/intrado.log
CHKSERVER=${ETC}/chkserver.output

# generally this will be run on a server when logging in
# but it can also be run on the utility servers to check out
# the status of a server or list of servers.
if [[ ! -z $1 ]]
then
  CHKSERVER=$ADMIN/servers/$1/chkserver.output
fi

if [[ ! -d ${INTRADO} ]]
then
  echo "Intrado scripts have not been installed."
else
  if [[ ! -f ${LOGS} ]]
  then
    echo "Intrado script has not been run yet."
  else
    RUNDATE=`ls -l ${LOGS} | awk '{print $7}'`
    TODAY=`date +"%d"`
    if [[ $RUNDATE -ne $TODAY ]]
    then
      echo "${LOGS} didn't run today (last ran: `date +\"%Y/${RUNDATE}/$m\"`)"
    else
      if [[ ! -f ${CHKSERVER} ]]
      then
        echo "${CHKSERVER} doesn't exist"
      else
        grep "chkserver v1" ${CHKSERVER}
        echo "Errors:"
        OUTPUT=`grep 31m ${CHKSERVER} | grep -v Error`
        if [[ ! -z $OUTPUT ]]
        then
          grep 31m ${CHKSERVER} | grep -v Error
        else
          echo "No chkserver errors found"
        fi
        echo ""
        echo "Warnings:"
        OUTPUT=`grep 33m ${CHKSERVER} | grep -v Warning`
        if [[ ! -z $OUTPUT ]]
        then
          grep 33m ${CHKSERVER} | grep -v Warning
        else
          echo "No chkserver warnings found"
        fi
      fi
    fi
  fi
fi

