#!/bin/ksh

# Carl Schelin
# need to make sure unixsvc can run privileged ansible playbooks without typing in a password
# 20170301 CS update to add '(%ansgrp)' and ansgrp with root membership

HOSTNAME=`hostname | cut -f1 -d. | tr [a-z] [A-Z]`
BINSH=`which sh`
SUDOTMP=/opt/intrado/etc/sudoers.unixsvc
OS=`uname`

# default
USERMOD=/sbin/usermod
GROUPADD=/sbin/groupadd

if [[ $OS = 'SunOS' ]]
then
  USERMOD=/usr/sbin/usermod
  GROUPADD=/usr/sbin/groupadd
fi

if [[ $OS = 'HP-UX' ]]
then
  USERMOD=/usr/sbin/usermod
  GROUPADD=/usr/sbin/groupadd
fi

# sun freeware install
if [[ -f /opt/sfw/etc/sudoers ]]
then
  SUDOERS='/opt/sfw/etc/sudoers'
fi

# default install
if [[ -f /etc/sudoers ]]
then
  SUDOERS='/etc/sudoers'
fi

# intrado custom install
if [[ -f /usr/local/etc/sudoers ]]
then
  SUDOERS='/usr/local/etc/sudoers'
fi

# hp-ux location
if [[ -f /opt/iexpress/sudo/etc/sudoers ]]
then
  SUDOERS='/opt/iexpress/sudo/etc/sudoers'
fi

# if no sudo file then it's not installed/not found
if [[ "$SUDOERS" = "" ]]
then
  echo "Not found" | mailx -s "Sudoers not found: $HOSTNAME" carl.schelin@intrado.com
  exit 0
fi

grep -q ansgrp /etc/group
if [[ $? = 1 ]]
then
  $GROUPADD ansgrp
fi

egrep -q "ansgrp.*root" /etc/group
if [[ $? = 1 ]]
then
  if [[ $OS = 'Linux' ]]
  then
    $USERMOD -a -G ansgrp root
  fi
  if [[ $OS = 'SunOS' ]]
  then
    $USERMOD -G ansgrp root
  fi
fi

if [[ -f $SUDOERS ]]
then
  grep -q ansgrp $SUDOERS
  if [[ $? = 1 ]]
  then
# back it up
    cp $SUDOERS $SUDOTMP
# remove old unixsvc info if it exists
    egrep -v "^unixsvc.*NOPASSWD:" $SUDOTMP > $SUDOERS

# add new info
    echo "" >> $SUDOERS
    echo "unixsvc		$HOSTNAME = (%ansgrp) NOPASSWD: $BINSH -c *" >> $SUDOERS
    echo "" >> $SUDOERS

  fi
fi

