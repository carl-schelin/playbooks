#!/bin/ksh

# Carl Schelin
# Remove the netbackup java package and restart the vxpbx_exchanged service
# the package isn't needed for netbackup and adds vulnerabilities

#BASENAME=$(basename "${0}")
DIRNAME=$(dirname "${0}")

if [[ ! -f ${DIRNAME}/../.config ]]
then
  echo "Unable to locate ${DIRNAME}/../.config. Exiting."
  exit 1
fi

# Source the configuration file
. "${DIRNAME}"/../.config

# if a changefreeze is in effect, stop the execution of the script.
if [[ -f ${SCRIPTS_DATA}/changefreeze ]]
then
  exit 0
fi

if [[ -f /etc/redhat-release ]]
then

  JAVA=$(rpm -qa | grep -i VRTSnbjava)

  if [[ ! -z $JAVA ]]
  then
    yum erase -y "${JAVA}"

    VERIFY=$(rpm -qa | grep -i VRTSnbjava)
    if [[ -z $VERIFY ]]
    then
      echo "${JAVA} has been uninstalled to address security vulnerabilities related to this version." | mailx -s "${HOSTNAME}" "${CHANGELOG}"
    fi

    service vxpbx_exchanged status > /dev/null
    if [[ $? = 0 ]]
    then
      service vxpbx_exchanged restart
    fi
  fi
fi

