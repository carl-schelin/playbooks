#!/bin/ksh

# chkov - Check the status of OpenView and restart if it's down
# Carl Schelin - 2/20/2008
# Added verification that openview is installed and is enabled
# changed path to ${SCRIPTS}/var to keep files in one directory structure
# add the ability to stop and start the script monitoring by passing stop or start to the chkov script

DIRNAME=$(dirname "$0")

if [[ ! -f ${DIRNAME}/../.config ]]
then
  echo "Unable to locate ${DIRNAME}/../.config. Exiting."
  exit 1
fi

# Source the configuration file
. "${DIRNAME}"/../.config

DATE=$(date)
LOG=${SCRIPTS}/var/openview.failed

# permit immediate running of scripts (within 5 minutes) if needed
# always delete it after one run
if [[ -f ${SCRIPTS}/bin/runnow ]]
then
  "${SCRIPTS}"/bin/runnow
  rm "${SCRIPTS}"/bin/runnow
fi

# check the Openview status
if [[ ! -z $1 ]]
then
  if [[ $1 = "stop" ]]
  then
    touch "${SCRIPTS}"/var/openview.stop
# kills the agent then exits; don't need to remove the kill here as the kill process will remove it when killed
    touch "${SCRIPTS}"/var/openview.kill
  fi
  if [[ $1 = "start" ]]
  then
    if [[ -f "${SCRIPTS}"/var/openview.stop ]]
    then
      rm "${SCRIPTS}"/var/openview.stop
    fi
  fi
fi

# if the kill flag is in place, kill the agent and then let it restart in 5 minutes
# gives us time to update configurations if necessary
if [[ -f ${SCRIPTS}/var/openview.kill ]]
then
  /opt/OV/bin/ovc -kill
  rm "${SCRIPTS}"/var/openview.kill
  exit 0
fi

# check to see if Openview monitoring is disabled
if [[ -f ${SCRIPTS}/var/openview.stop ]]
then
  echo "Openview configured to not auto-start"
  exit 0
fi

# now run through checks to see if OpenView is working.
for i in $(/opt/OV/bin/opcagt -status | egrep -i "(Aborted|Stopped|Isn't Running)" | awk '{print $1}')
do
  echo "OpenView module ${i} has errored out and is not communicating - restarting ${i}"
  /usr/bin/logger -p err -t "OpenView" "An OpenView module (${i}) has errored out (Aborted|Stopped|Isn't Running). Restarting ${i}."

  echo "" >> "${LOG}"
  echo "${DATE}" >> "${LOG}"
  /opt/OV/bin/opcagt -start "${i}" >> "${LOG}"
  /opt/OV/bin/opcagt -status >> "${LOG}"

done

# this takes about 15 seconds and restarts

ERROR=$(/opt/OV/bin/ovc -status 2>&1)
if [[ $ERROR = "(ctrl-111) Ovcd is not yet started." ]]
then
  echo "OpenView is not running - restarting"
  /usr/bin/logger -p err -t "OpenView" "OpenView is not running. Restarting OpenView."
  /opt/OV/bin/ovc -start
fi

