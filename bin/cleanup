#!/bin/ksh

# prevent the Netbackup Fiber Transport client from starting. Caused an incident where incofmc2 failed to completely start due to the nbfbclnt script halting on starting the agent.
if [[ -f /usr/openv/netbackup/bin/nbftclnt ]]
then
  chmod -x /usr/openv/netbackup/bin/nbftclnt
fi

for i in chkdef chketh chkif chkov chkprinter chkraid chksan chkstack chksudo chksudoers chkusers chkusers.contrib chkversion logme
do
  if [[ -f /usr/local/bin/$i ]]
  then
    echo "Removing /usr/local/bin/$i"
    rm /usr/local/bin/$i
  fi
done

for i in arcconf.output chketh.output chkstack.output chksudo.output chkusers.dat defunct.data ifconfig.output megarc.output metadb.output metastat.output raidctl.output
do
  if [[ -f /usr/local/etc/$i ]]
  then
    echo "Removing /usr/local/etc/$i"
    rm /usr/local/etc/$i
  fi
done

if [[ -d /opt/cfghtml ]]
then
  echo "Moving /opt/cfghtml to /opt/intrado/"
  mv /opt/cfghtml /opt/intrado/
fi

if [[ -d /opt/ov ]]
then
  if [[ -f /opt/OV/bin/ovc ]]
  then
    echo "Removing /opt/ov"
    rm -rf /opt/ov
  fi
fi

if [[ -d /opt/nbu ]]
then
  if [[ -f /usr/openv/netbackup/bp.conf ]]
  then
    echo "Removing /opt/nbu"
    rm -rf /opt/nbu
  fi
fi

if [[ -f /var/tmp/openview.failed ]]
then
  echo "Moving openview.failed to /opt/intrado/var"
  mv /var/tmp/openview.failed /opt/intrado/var/
fi

if [[ -f /usr/local/patchdiag ]]
then
  echo "Removing /usr/local/patchdiag"
  rm -rf /usr/local/patchdiag
fi

if [[ -f /opt/intrado/etc/motd ]]
then
  cp /opt/intrado/etc/motd /etc/motd
  cp /opt/intrado/etc/motd /etc/issue
fi

if [[ -f /tmp/newuser ]]
then
  rm /tmp/newuser
  rm /tmp/newuser.add
  rm /tmp/newuser.pw
  rm /tmp/newuser.users
fi

if [[ ! -f /usr/bin/ksh ]]
then
  if [[ -f /bin/ksh ]]
  then
    ln -s /bin/ksh /usr/bin/ksh
  fi
fi

# change ownership of unixsvc authorized_keys file
UNIXSVC=$(grep "^unixsvc:" /etc/passwd | cut -f6 -d:)
if [[ ! -z $UNIXSVC ]]
then
  chown unixsvc:unixsvc "${UNIXSVC}"/.ssh/*
  chmod 600 "${UNIXSVC}"/.ssh/*
  chmod 700 "${UNIXSVC}"/.ssh
fi

# remove log files older than 10 days
find /opt/intrado/var -name logfile.* -atime +10 -exec rm {} \;

# and remove old log files than 90 days (3 files)
find /opt/intrado/var -name intrado.log.* -atime +92 -exec rm {} \;

# remove runnow script if it exists. the chkov script deletes it after running but if chkov isn't enabled, it won't run or be removed. This auto-removes it.
if [[ -f /opt/intrado/bin/runnow ]]
then
  rm /opt/intrado/bin/runnow
fi
if [[ -f /opt/intrado/bin/runonce ]]
then
  rm /opt/intrado/bin/runonce
fi

# delete any retired scripts and data files.

for i in chkarray chkems chkipcs chkomsa chkroutetable chksudo sync-clock leaping ovhfchk ovupdate retired setdate
do
  if [[ -f /opt/intrado/bin/$i ]]
  then
    rm /opt/intrado/bin/$i
  fi
done

for i in chkarray.output chkems.output chkipcs.output chksudo.output leaping.run chkomsa.out routetable.output chksecurity.output chksudo.output chktime.output
do
  if [[ -f /opt/intrado/etc/$i ]]
  then
    rm /opt/intrado/etc/$i
  fi
done

for i in leaping.log
do
  if [[ -f /opt/intrado/var/$i ]]
  then
    rm /opt/intrado/var/$i
  fi
done

# server specific files that aren't needed any more

SERVERS="coolcaecada11 coolcaecera11 coolcaecera1b coolcaecera21 coolcaecera2b coolcaecera31 enwdcoecada1b enwdcoecadb1b enwdcoecera1b enwdcoecera2b enwdcoecera3b enwdcoecerb1b "
SERVERS="$SERVERS enwdcoecerb2b enwdcoecerb3b enwdcoecmpb1b enwdcoecutb1b lnmtcodccl20 miamfldctxb0 miamflecada1b miamflecadb1b miamflecera1b miamflecera2b miamflecera3b "
SERVERS="$SERVERS miamflecerb1b miamflecerb2b miamflecerb3b miamflecuta1b miamflecutb1b incoov01 chksudo chksecurity chksync chktime"

for i in $SERVERS
do
  if [[ -f /opt/intrado/bin/$i ]]
  then
    rm /opt/intrado/bin/$i
  fi
done

