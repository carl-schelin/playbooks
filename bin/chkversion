#!/bin/ksh

# Carl Schelin
# 8/20/2011 - get version information from various tools on the system.
# - openview - has to get it running as root.
# - netbackup - just copying it from the netbackup directory
# - openview - added outputting it's not installed
# - netbackup - added outputting it's not installed
# - openview - use the right command to check versions
# 20140403 - Only run the commands/copy files/etc if the version file doesn't exist. Keeps from continually running the command
# 20140416 - check sudo version
# 20140729 - Return to running commands each night.
# 20140902 - Added version check for openview if opcagt doesn't exist.
# 20140918 - Added alternate version check for openview if opcagt doesn't exist in /opt/OV/bin.
# 20150113 - Get Oracle smon values (asm_smon/ora_smon) to get ASM and instance names.
# 20150718 - Get Postgres version
# 20150718 - Get Informix version
# 20150816 - Change mysql check as ./mysqld was found on several servers
# 20151006 - Check for data palette and Panorama (opnet) installation
# 20170331 - remove ovc.version file if it exists
# 20180322 - Updated it to fully clean and added wildfly and newrelic

#BASENAME=$(basename "${0}")
DIRNAME=$(dirname "${0}")

if [[ ! -f ${DIRNAME}/../.config ]]
then
  echo "Unable to locate ${DIRNAME}/../.config. Exiting."
  exit 1
fi

# Source the configuration file
. "${DIRNAME}"/../.config

ADMIN=/opt/intrado

# clean up
for i in datapal httpd informix mysqld netbackup newrelic omsa opnet oracle ovc postgres sudo vmtoolsd wildfly
do
  if [[ -f ${SCRIPTS_DATA}/$i.version ]]
  then
    rm "${SCRIPTS_DATA}/$i.version"
  fi
done

# checking installed software
# for the chksys script, at least one line needs to be added even if it's just "Installed"

##############################################
### Data Palette - datapal.version
##############################################

if [[ -f /opt/datapalette/bin/datapal ]]
then
  echo "Installed" > "${SCRIPTS_DATA}/datapal.version"
fi

##############################################
### HTTPD - httpd.version
##############################################

OUTPUT=$(ps -e | grep httpd)
if [[ ! -z $OUTPUT ]]
then
# if started in the last 24 hours, it'll be hh:mm:ss
  OUTPUT=$(ps -ef | grep -v grep | grep httpd | head -1 | awk '{print $8}')
  if [[ ! -x $OUTPUT ]]
  then
# if been up a while, it'll be Oct 16'
    OUTPUT=$(ps -ef | grep -v grep | grep httpd | head -1 | awk '{print $9}')
  fi
  $OUTPUT -version | head -1 > "${SCRIPTS_DATA}/httpd.version"
fi

##############################################
### Informix - informix.version
##############################################

OUTPUT=$(ps -ef | grep oninit | grep -v grep)
if [[ ! -z $OUTPUT ]]
then
  if [[ -f /usr/informix/bin/onstat ]]
  then
    /usr/informix/bin/onstat - | grep -v "^$" | head -1 > "${SCRIPTS_DATA}/informix.version"
  fi
fi

##############################################
### MySQLd - mysqld.version
##############################################

OUTPUT=$(ps -e | grep mysqld)
if [[ ! -z $OUTPUT ]]
then
# if started in the last 24 hours, it'll be hh:mm:ss
  OUTPUT=$(ps -ef | grep -v grep | grep 'mysqld ' | head -1 | awk '{print $8}')
  if [[ ! -x $OUTPUT ]]
  then
# if been up a while, it'll be Oct 16'
    OUTPUT=$(ps -ef | grep -v grep | grep 'mysqld ' | head -1 | awk '{print $9}')
  fi
# mysql is installed but run as './mysqld' vs an absolute path. at least this tells you it's been found
  if [[ -f $OUTPUT ]]
  then
    $OUTPUT --version | head -1 > "${SCRIPTS_DATA}/mysqld.version"
  else
    OUTPUT=$(find /opt -name mysqld -print | sort | tail -1)
    if [[ -f $OUTPUT ]]
    then
      $OUTPUT --version | head -1 > $ADMIN/etc/mysqld.version
    else
      echo "$OUTPUT running but can't get version" > "${SCRIPTS_DATA}/mysqld.version"
    fi
  fi
fi

##############################################
### Netbackup - netbackup.version
##############################################

if [[ -f /usr/openv/netbackup/bin/version ]]
then
  cp /usr/openv/netbackup/bin/version "${SCRIPTS_DATA}/netbackup.version"
fi

##############################################
### New Relic - newrelic.version
##############################################

OUTPUT=$(ps -ef | grep newrelic | grep -v grep)
if [[ ! -z $OUTPUT ]]
then
  echo "Installed" > "${SCRIPTS_DATA}/newrelic.version"
fi

##############################################
### Dell Open Manage Report - omsa.version
##############################################

if [[ -x /opt/dell/srvadmin/bin/omreport ]];
 then
   /opt/dell/srvadmin/bin/omreport about > "${SCRIPTS_DATA}/omsa.version"
fi

##############################################
### Openview - ovc.version
##############################################

if [[ -f /opt/OV/bin/opcagt ]]
then
  /opt/OV/bin/opcagt -version > "${SCRIPTS_DATA}/ovc.version"
else
  if [[ -f /opt/OV/bin/OpC/opcagt ]]
  then
    /opt/OV/bin/OpC/opcagt -version > "${SCRIPTS_DATA}/ovc.version"
  else
    if [[ -f /opt/OV/bin/ovc ]]
    then
      /opt/OV/bin/ovc -version > "${SCRIPTS_DATA}/ovc.version"
    fi
  fi
fi

##############################################
### Opnet - opnet.version
##############################################

if [[ -d /opt/Panorama ]]
then
  echo "Installed" > "${SCRIPTS_DATA}/opnet.version"
fi

##############################################
### Oracle - oracle.version
##############################################

OUTPUT=$(ps -ef | egrep "(asm|ora)_smon" | grep -v grep | awk '{print $NF}' | cut -f3 -d_)
if [[ ! -z $OUTPUT ]]
then
  for i in $OUTPUT
  do
    echo "${i}" >> "${SCRIPTS_DATA}/oracle.version"
  done
fi

##############################################
### Postgres - postgres.version
##############################################

OUTPUT=$(ps -ef | grep pgsql | grep -v grep)
if [[ ! -z $OUTPUT ]]
then
# if started in the last 24 hours, it'll be hh:mm:ss
  OUTPUT=$(ps -ef | grep -v grep | grep 'pgsql' | head -1 | awk '{print $8}')
  if [[ ! -x $OUTPUT ]]
  then
# if been up a while, it'll be Oct 16'
    OUTPUT=$(ps -ef | grep -v grep | grep 'pgsql' | head -1 | awk '{print $9}')
  fi
  DIR=$(dirname "${OUTPUT}")
  "${DIR}/psql" --version | head -1 > "${SCRIPTS_DATA}/postgres.version"
fi

##############################################
### sudo - sudo.version
##############################################

if [[ -f /usr/local/bin/sudo ]]
then
  /usr/local/bin/sudo -V | head -1 > "${SCRIPTS_DATA}/sudo.version"
fi

##############################################
### VMWare Tools - vmtoolsd.version
##############################################

if [[ -f /usr/sbin/vmtoolsd ]]
then
  /usr/sbin/vmtoolsd -v > "${SCRIPTS_DATA}/vmtoolsd.version"
fi

##############################################
### Wildfly - wildfly.version
##############################################

OUTPUT=$(ps -ef | grep wildfly | grep -v grep)
if [[ ! -z $OUTPUT ]]
then
  echo "Installed" > "${SCRIPTS_DATA}/wildfly.version"
fi


